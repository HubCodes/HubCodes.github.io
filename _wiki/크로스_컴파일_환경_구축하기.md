---
layout  : wiki
title   : 크로스 컴파일 환경 구축하기
summary : 극적으로 빌드 속도를 개선해보자
date    : 2020-11-20 20:33:14 +0900
updated : 2020-11-20 20:33:14 +0900
tag     : linux 
toc     : true
public  : true
parent  : [[index]]
latex   : false
---
* TOC
{:toc}

라즈베리 파이를 가지고 리눅스 커널 공부를 하면서 자연스럽게 커널을 자주 빌드하게 되었다. 이미 빌드 
결과물이 있는 상태에서 변경사항을 조금씩 적용해 보는 수준까지는 괜찮겠지만, 아무것도 없는 상태에서
처음부터 빌드를 진행하려고 하면 여간 시간이 오래 걸리는 게 아니다. 정확하게 측정은 안 해 봤지만 대강
2시간이 소요되었는데, 이 정도의 빌드 시간을 감내하는 것은 다소 힘들다고 생각했다.

이 문제를 해결하려면 다른 컴퓨터에서 빌드한 다음에 라즈베리 파이에서 가지고 와서 적용하는 일련의 과정이
필요하다. 이를 위해 별도의 컴퓨터가 필요한데, 다행히 나는 인텔 기반의 리눅스 머신을 가지고
있어서 그 컴퓨터에서 빌드를 돌리기로 마음먹었다.

# 빌드용 머신에 크로스 컴파일러 설치하기

라즈베리 파이는 공식 레포지터리에서 [여러 도구](https://github.com/raspberrypi/tools)를
제공하는데, 그 중에는 인텔 리눅스에서 사용할 수 있는 크로스 컴파일러도 포함이 되어 있다. 이것을
그대로 사용하면 라즈베리 파이용 리눅스 커널을 빌드할 수 있다.

```sh
git clone https://github.com/raspberrypi/tools
```

해당 레포지터리를 클론받아서 열어보면 여러 디렉터리가 보이는데, 지금 필요한 디렉터리는
`/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian/bin/` 이다. 이 안에는
라즈베리파이 3용 컴파일러는 물론 어셈블러, 링커, 디버거, 유틸 등이 포함되어 있다.

```
PATH=$PATH:~/workspace/rpi-cross/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian/bin/
KERNEL=kernel7
```

`.build` 라는 파일을 만들어서 저장하고, 커널 소스 디렉토리 맨 위에 진입할때 한 번 씩
`source .build` 해 주면 PATH에 크로스 컴파일러가 들어온다. (지금은 대충 해 두었지만,
나중에는 direnv를 적용해서 그 과정을 자동화 해볼 수 있을 것 같다)

# 효과

빌드를 돌린 머신 사양은 다음과 같다.

Kernel | CPU   | Memory
-------|:-----:|-------
Linux 5.9.10 | AMD Ryzen 2600 (6C 12T) | 24GB DDR4

정확하게 측정하지는 않았는데, 앞선 2시간에 비해 너무도 차이가 컸기 때문이다. **약 2~3분**이면 커널
빌드를 완료할 수 있었다.
